// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Drawing;
using System.ComponentModel;

using BlahguaMobile.BlahguaCore;

using MonoTouch.SlideMenu;
using MonoTouch.Foundation;
using MonoTouch.UIKit;
using MonoTouch.Dialog.Utilities;

namespace BlahguaMobile.IOS
{
	public partial class BGRollViewController : UICollectionViewController, IImageUpdated
	{
		#region Fields

		private SlideMenuController leftSlidingPanel;
		private BGRollViewCellsSizeManager manager;
		private UIButton profile;
		private UIButton newBlah;

		#endregion

		#region Properties
		#endregion

		public BGRollViewController (IntPtr handle) : base (handle)
		{
		}

		#region View Controller Overriden Methods

		public override void ViewDidLoad ()
		{
			base.ViewDidLoad ();

			CollectionView.BackgroundColor = UIColor.FromPatternImage (UIImage.FromFile ("grayBack.png"));

			leftSlidingPanel = ((AppDelegate)UIApplication.SharedApplication.Delegate).SlideMenu;

			NavigationItem.LeftBarButtonItem = new UIBarButtonItem (UIImage.FromFile("leftMenuButton.png"), UIBarButtonItemStyle.Plain, MenuButtonClicked);
			if(BlahguaCore.BlahguaAPIObject.Current.CurrentUser == null)
			{
				NavigationItem.RightBarButtonItem = new UIBarButtonItem ("Log in", UIBarButtonItemStyle.Plain, LoginButtonClicked);
			}
			else
			{
				profile = new UIButton (new RectangleF (0, 0, 44, 44));
				var profileImage = ImageLoader.DefaultRequestImage (new Uri (BlahguaCore.BlahguaAPIObject.Current.CurrentUser.UserImage), this);
				profile.SetImage (profileImage, UIControlState.Normal);
				newBlah = new UIButton (new RectangleF (44, 0, 44, 44));
				newBlah.BackgroundColor = UIColor.FromRGB (229, 203, 45);
				newBlah.SetImage (UIImage.FromFile ("newBlahImage.png"), UIControlState.Normal);

				UIView view = new UIView (new RectangleF (0, 0, 88, 44));
				view.AddSubviews (new UIView[] { profile, newBlah });

				NavigationItem.RightBarButtonItem = new UIBarButtonItem (view);
			}

			BlahguaCore.BlahguaAPIObject.Current.PropertyChanged += (object sender, PropertyChangedEventArgs e) => 
			{
				if(e.PropertyName == "CurrentChannel")
				{
					CollectionView.ScrollToItem(NSIndexPath.FromItemSection(0, 0), UICollectionViewScrollPosition.Top, true);
					InvokeOnMainThread(() => {
						var dataSource = ((BGRollViewDataSource)CollectionView.DataSource);
						dataSource.DataSource.Clear();
						CollectionView.ReloadData();
					});
					BlahguaAPIObject.Current.GetInbox (InboxLoadingCompleted);
				}
			};

			manager = new BGRollViewCellsSizeManager ();
			BlahguaAPIObject.Current.GetInbox (InitialInboxLoadingCompleted);
		}

		#endregion

		#region Methods

		public void RefreshData()
		{
			BlahguaAPIObject.Current.GetInbox (InboxLoadingCompleted);
		}

		public void DeleteFirst200Items()
		{
			((BGRollViewDataSource)CollectionView.DataSource).DeleteFirst350Items ();
		}


		private void MenuButtonClicked(object sender, EventArgs args)
		{
			leftSlidingPanel.ToggleMenuAnimated ();
		}

		private void LoginButtonClicked(object sender, EventArgs args)
		{
			PerformSegue ("fromRollToLogin", this);
		}

		private void InitialInboxLoadingCompleted (Inbox theList)
		{
			InvokeOnMainThread (() => {
				CollectionView.DataSource = new BGRollViewDataSource (manager, this);
				CollectionView.CollectionViewLayout = new BGRollViewLayout (manager, this);
				CollectionView.Delegate = new BGRollViewLayoutDelegate (manager);
				InboxLoadingCompleted (theList);
			});
		}
			
		private void InboxLoadingCompleted(Inbox inbox)
		{
			InvokeOnMainThread (() => {
				((BGRollViewDataSource)CollectionView.DataSource).InsertItems(inbox);
			});
		}

		#endregion


		#region IImageUpdated implementation

		public void UpdatedImage (Uri uri)
		{
			profile.SetImage (ImageLoader.DefaultRequestImage (new Uri (BlahguaCore.BlahguaAPIObject.Current.CurrentUser.UserImage), this), UIControlState.Normal);
		}

		#endregion

	}
}
